<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoboCook</title>
    <meta name="apple-mobile-web-app-title" content="RoboCook">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%232c3e50%22 rx=%2220%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ü§ñ</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root { 
            --brand-color: #2c3e50; 
            --accent-color: #e67e22;
            --bg-color: #fcfcfc; 
            --error-red: #c0392b;
            --success-green: #27ae60;
            --tab-active: #34495e;
            --tab-inactive: #ecf0f1;
        }
        
        html { height: 100%; overscroll-behavior: none; }
        body { font-family: 'Lato', sans-serif; background: var(--bg-color); padding: 20px; color: #333; max-width: 850px; margin: 0 auto; padding-bottom: env(safe-area-inset-bottom); }
        
        .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        h1 { color: var(--brand-color); text-align: center; margin-top: 0; font-family: 'Playfair Display', serif; font-size: 2.5em; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 1em; margin-bottom: 30px; font-style: italic; }

        .section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #eee; }
        .legal-footer { font-size: 0.7em; color: #bdc3c7; text-align: center; margin-top: 40px; }

        label { font-weight: bold; display: block; margin-bottom: 8px; color: #2c3e50; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #bdc3c7; border-radius: 8px; font-family: inherit; -webkit-appearance: none; box-sizing: border-box; }
        
        .tab-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #7f8c8d; background: var(--tab-inactive); transition: 0.2s; }
        .tab-btn.active { background: var(--tab-active); color: white; }
        .input-panel { display: none; }
        .input-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        button.main-btn { width: 100%; padding: 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-primary:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-check { background: var(--brand-color); color: white; width: 100%; padding: 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px; }
        
        .btn-help { background: #ecf0f1; color: var(--brand-color); border: none; padding: 4px 10px; font-size: 0.8em; margin-left: 10px; cursor: pointer; border-radius: 4px; }
        .btn-remove { background: transparent; color: #95a5a6; border: 1px solid #ecf0f1; padding: 8px; font-size: 12px; margin-top: 5px; cursor: pointer; border-radius: 4px; }

        .status-box { padding: 15px; border-radius: 8px; font-size: 0.95em; margin-top: 15px; display: none; line-height: 1.4; }
        .status-error { background: var(--error-red); color: white; }
        .status-success { background: var(--success-green); color: white; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; }
        .close-modal { float: right; font-size: 28px; cursor: pointer; color: #999; }

        #recipeCard { display: none; margin-top: 40px; border: 1px solid #ecf0f1; padding: 30px; border-radius: 12px; background: #fff; position: relative; }
        #recipeCard::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(to right, var(--brand-color), var(--accent-color)); border-radius: 12px 12px 0 0; }
        
        .recipe-header { border-bottom: 2px dashed #ecf0f1; margin-bottom: 25px; padding-bottom: 15px; }
        .recipe-title { font-family: 'Playfair Display', serif; font-size: 2.2em; color: var(--brand-color); margin: 0 0 10px 0; font-weight: 700; }
        .recipe-meta { font-size: 0.9em; color: #7f8c8d; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }

        .step { margin-bottom: 30px; }
        .step-web-container { border-left: 4px solid var(--accent-color); padding-left: 20px; }
        .step-action-title { font-weight: bold; color: var(--accent-color); text-transform: uppercase; font-size: 0.85em; letter-spacing: 1.5px; display: block; margin-bottom: 8px; }
        .step-desc { font-size: 1.1em; color: #34495e; }
        .tm6-tag { display: inline-block; background: #f8f9fa; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; margin-top: 10px; color: #7f8c8d; border: 1px solid #ecf0f1; font-family: 'Roboto Mono', monospace; }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            .no-print, .section, .tab-group, .input-panel, h1, .subtitle, button, .status-box, .modal, .legal-footer { display: none !important; }
            #recipeCard { display: block !important; border: none; padding: 0; margin: 0; }
            #recipeCard::before { display: none; }
            .recipe-header { text-align: center; border-bottom: 3px double #2c3e50; }
            .recipe-title { font-size: 24pt; color: #000; }
            .step { page-break-inside: avoid; margin-bottom: 20px; display: flex; }
            .step::before { content: counter(step-counter); counter-increment: step-counter; background: #2c3e50; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; font-size: 12pt; }
            #stepsContainer { counter-reset: step-counter; }
            .step-web-container { border: none; padding: 0; }
            .tm6-tag { border: 1px solid #000; color: #000; background: white !important; }
            #printFooter { display: block !important; margin-top: 50px; font-size: 8pt; text-align: center; color: #999; }
        }
        #printFooter { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="no-print">ü§ñ RoboCook <span style="color:var(--accent-color)">ChefGPT</span></h1>
        <div class="subtitle no-print">Il tuo assistente di cucina AI</div>

        <div class="section no-print">
            <label>
                1. Google API Key 
                <button class="btn-help" onclick="toggleModal(true)">?</button>
                <span id="savedBadge" style="display:none; color:green; font-size:0.8em; margin-left:10px;">(Salvata nel PC)</span>
            </label>
            <input type="password" id="apiKey" placeholder="Inserisci la tua Google AI Key..." />
            <button class="btn-check" onclick="findWorkingModel()">üîÑ Connetti Chiave</button>
            <button class="btn-remove" onclick="removeKey()" id="removeBtn" style="display:none;">Disconnetti</button>
            <div id="configStatus" class="status-box"></div>
            <div id="modelSelectionArea" style="display:none; margin-top:10px;">
                <select id="modelSelect" style="width:100%; padding:8px; background:#f9f9f9; border:1px solid #ddd;"></select>
            </div>
        </div>

        <div class="section no-print">
            <label>2. Ricetta da convertire</label>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('text')">üìù Incolla Testo</button>
                <button class="tab-btn" onclick="switchTab('url')">üåê Importa URL</button>
            </div>

            <div id="panel-url" class="input-panel">
                <input type="text" id="urlInput" placeholder="https://www.giallozafferano.it/..." />
                <p style="font-size:0.85em; color:#95a5a6; margin-top:8px;">
                    <strong>Nota:</strong> Alcuni siti (come GialloZafferano) bloccano l'accesso automatico. Se vedi un errore, usa il tasto "Incolla Testo" e copia manualmente la ricetta.
                </p>
            </div>

            <div id="panel-text" class="input-panel active">
                <textarea id="recipeInput" style="height:150px" placeholder="Incolla qui il testo della ricetta..."></textarea>
            </div>
            
            <button id="convertBtn" class="main-btn btn-primary" onclick="processRecipe()" disabled>
                üîí Inserisci API Key
            </button>
        </div>

        <div id="recipeCard">
            <div class="recipe-header">
                <h2 id="resTitle" class="recipe-title">...</h2>
                <span id="resServings" class="recipe-meta">...</span>
            </div>
            <div id="stepsContainer"></div>
            <div id="printFooter">Ricetta elaborata da RoboCook ChefGPT - Uso Personale</div>
        </div>

        <button id="printBtn" class="main-btn btn-print no-print" style="display:none;" onclick="window.print()">
            üñ®Ô∏è Stampa PDF / Salva
        </button>

        <div class="legal-footer no-print">
            RoboCook ChefGPT √® un software sperimentale. Non affiliato a Vorwerk¬Æ o GialloZafferano.
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="closeModalOnClick(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal(false)">&times;</span>
            <h2 style="color:var(--brand-color)">API Key Google</h2>
            <ol style="padding-left:20px; line-height:1.6;">
                <li>Vai su <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                <li>Crea chiave gratuita.</li>
                <li>Incollala qui.</li>
            </ol>
        </div>
    </div>

    <script>
        let currentMode = 'text';
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.input-panel').forEach(p => p.classList.remove('active'));
            if(mode === 'text') {
                document.querySelectorAll('button[onclick="switchTab(\'text\')"]')[0].classList.add('active');
                document.getElementById('panel-text').classList.add('active');
            } else {
                document.querySelectorAll('button[onclick="switchTab(\'url\')"]')[0].classList.add('active');
                document.getElementById('panel-url').classList.add('active');
            }
        }
        function toggleModal(show) { document.getElementById('helpModal').style.display = show ? 'block' : 'none'; }
        function closeModalOnClick(e) { if(e.target==document.getElementById('helpModal')) toggleModal(false); }

        const STORAGE_KEY = 'robocook_key';
        window.onload = function() {
            const k = localStorage.getItem(STORAGE_KEY);
            if(k) {
                document.getElementById('apiKey').value = k;
                document.getElementById('savedBadge').style.display = 'inline';
                document.getElementById('removeBtn').style.display = 'inline-flex';
                findWorkingModel(true);
            }
        };
        function removeKey() {
            if(confirm("Disconnettere?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
        }

        async function findWorkingModel(auto=false) {
            const key = document.getElementById('apiKey').value.trim();
            const sb = document.getElementById('configStatus');
            const mb = document.getElementById('modelSelect');
            const btn = document.getElementById('convertBtn');

            if(key.length<5) return !auto && alert("Chiave mancante.");
            sb.style.display='block'; sb.className='status-box'; sb.innerText= auto ? "Connessione..." : "Verifica...";

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
                const mods = d.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
                if(mods.length===0) throw new Error("Nessun modello AI.");
                mods.sort((a,b) => (b.name.includes('flash')?1:0)-(a.name.includes('flash')?1:0));

                mb.innerHTML="";
                mods.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name.replace('models/',''); opt.text = opt.value;
                    mb.appendChild(opt);
                });

                localStorage.setItem(STORAGE_KEY, key);
                document.getElementById('savedBadge').style.display='inline';
                document.getElementById('removeBtn').style.display='inline-flex';
                sb.className='status-box status-success'; sb.innerText="‚úÖ Connesso";
                document.getElementById('modelSelectionArea').style.display='block';
                btn.disabled=false; btn.innerHTML="‚ú® <b>Genera Ricetta</b>";

            } catch(e) {
                sb.className='status-box status-error'; sb.innerText="‚ùå Errore: " + e.message;
            }
        }

        // --- LOGICA MULTI-PROXY ---
        async function fetchWithProxy(url, proxyService) {
            let fetchUrl = '';
            if (proxyService === 1) fetchUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            if (proxyService === 2) fetchUrl = `https://corsproxy.io/?url=${encodeURIComponent(url)}`;
            if (proxyService === 3) fetchUrl = `https://thingproxy.freeboard.io/fetch/${url}`;

            console.log(`Tentativo Proxy ${proxyService}...`);
            
            const res = await fetch(fetchUrl);
            if (!res.ok) throw new Error(`Proxy ${proxyService} fallito`);
            
            if (proxyService === 1) {
                const data = await res.json();
                return data.contents;
            } else {
                return await res.text();
            }
        }

        async function fetchWebPage(url) {
            let htmlText = "";
            
            // Tenta 3 proxy in sequenza
            try { htmlText = await fetchWithProxy(url, 2); } 
            catch (e) { 
                try { htmlText = await fetchWithProxy(url, 1); }
                catch (e2) {
                    try { htmlText = await fetchWithProxy(url, 3); }
                    catch (e3) { throw new Error("Tutti i tentativi di connessione sono falliti. Il sito √® protetto."); }
                }
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // Cerca JSON-LD (Metodo pi√π affidabile)
            const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
            for(const s of scripts) {
                if(s.innerText.includes("Recipe")) return "DATI_JSON_LD: " + s.innerText;
            }
            
            // Fallback testo grezzo
            doc.querySelectorAll('script, style, nav, footer, header, iframe, .advertisement').forEach(e => e.remove());
            return (doc.querySelector('main') || doc.body).innerText.substring(0, 30000);
        }

        async function processRecipe() {
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelSelect').value;
            const out = document.getElementById('stepsContainer');
            const card = document.getElementById('recipeCard');
            const pBtn = document.getElementById('printBtn');

            out.innerHTML = '<div style="text-align:center; padding:30px; color:#7f8c8d;">‚è≥ <b>RoboCook sta elaborando...</b></div>';
            card.style.display='block'; pBtn.style.display='none';
            card.scrollIntoView({behavior:'smooth'});

            try {
                let textData = "";
                if(currentMode === 'url') {
                    const url = document.getElementById('urlInput').value;
                    if(!url) throw new Error("URL mancante");
                    out.innerHTML = '<div style="text-align:center; padding:30px;">üåê Importazione (Tentativo Multi-Proxy)...</div>';
                    textData = await fetchWebPage(url);
                } else {
                    textData = document.getElementById('recipeInput').value;
                    if(!textData) throw new Error("Testo mancante");
                }

                out.innerHTML = '<div style="text-align:center; padding:30px;">ü§ñ <b>Conversione in corso...</b></div>';

                const PROMPT = `
                Agisci come RoboCook, assistente esperto di robot da cucina (tipo TM6).
                Compito:
                1. Estrai Titolo e Porzioni.
                2. Converti la ricetta passo passo.
                3. INSERISCI LE QUANTIT√Ä nel testo di ogni passo.
                4. Genera settings: Trito (Vel 5-8), Soffritto (120¬∞C), Cottura (100¬∞C Antiorario), Vapore (Varoma).
                OUTPUT JSON: { "title": "...", "servings": "...", "steps": [ {"action":"...", "desc":"...", "tm6":"..."} ] }
                `;

                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT + "\n\nINPUT:\n" + textData }] }] })
                });

                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
                let raw = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();
                const json = JSON.parse(raw);

                document.getElementById('resTitle').innerText = json.title || "Ricetta";
                document.getElementById('resServings').innerText = json.servings || "";

                out.innerHTML = "";
                json.steps.forEach((s,i) => {
                    out.innerHTML += `
                    <div class="step">
                        <div class="step-web-container">
                            <span class="step-action-title">FASE ${i+1}: ${s.action}</span>
                            <div class="step-desc">${s.desc}</div>
                            <div class="tm6-tag">‚öôÔ∏è ${s.tm6}</div>
                        </div>
                    </div>`;
                });
                pBtn.style.display='block';

            } catch(e) {
                out.innerHTML = `<div class="status-box status-error">
                    <b>Errore Importazione:</b> ${e.message}<br><br>
                    ‚ö†Ô∏è <b>Il sito ha bloccato l'accesso automatico.</b><br>
                    Niente paura! Fai cos√¨:<br>
                    1. Vai sulla pagina della ricetta.<br>
                    2. Seleziona tutto il testo e copialo.<br>
                    3. Torna qui, clicca su <b>"Incolla Testo"</b> e incolla.<br>
                    L'IA funzioner√† comunque perfettamente!
                </div>`;
            }
        }
    </script>
</body>
</html>
