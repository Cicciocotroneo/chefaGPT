<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboCook - ChefGPT Editor</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root { 
            --robo-green: #3f5e55; 
            --robo-dark: #2c423b;
            --bg-color: #f4f7f6; 
            --error-red: #ffecec;
            --success-green: #e8f5e9;
            --tab-active: #2c423b;
            --tab-inactive: #e0e0e0;
        }
        
        body { 
            font-family: 'Lato', sans-serif; 
            background: var(--bg-color); 
            padding: 20px; 
            color: #333; 
            max-width: 850px; 
            margin: 0 auto; 
            line-height: 1.6;
        }
        
        /* --- STILI INTERFACCIA WEB --- */
        .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        h1 { color: var(--robo-green); text-align: center; margin-top: 0; font-family: 'Playfair Display', serif; }
        
        .section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #eee; }
        
        /* INPUT UI */
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #555; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        
        /* TABS */
        .tab-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; background: var(--tab-inactive); transition: 0.2s; }
        .tab-btn.active { background: var(--tab-active); color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .input-panel { display: none; }
        .input-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* BOTTONI */
        button.main-btn { width: 100%; padding: 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 15px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .btn-primary { background: var(--robo-green); color: white; box-shadow: 0 4px 10px rgba(63, 94, 85, 0.3); }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .btn-check { background: #4b90ff; color: white; width: 100%; padding: 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px; }
        
        /* Action Group */
        .action-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-print { background: #333; color: white; flex: 1; }
        .btn-save { background: #f0932b; color: white; flex: 1; border:none; border-radius:8px; font-weight:bold; cursor:pointer; padding:16px; display: flex; align-items:center; justify-content:center; gap:8px;}
        .btn-save:hover { background: #d35400; }
        
        .btn-help { background: #eef5f3; color: var(--robo-green); border: 1px solid #dce4e2; padding: 4px 10px; font-size: 0.8em; margin-left: 10px; cursor: pointer; border-radius: 4px; }
        .btn-remove { background: transparent; color: #999; border: 1px solid #ddd; padding: 8px; font-size: 12px; margin-top: 5px; cursor: pointer; border-radius: 4px; }

        .status-box { padding: 15px; border-radius: 8px; font-size: 0.95em; margin-top: 15px; display: none; }
        .status-error { background: var(--error-red); color: #d32f2f; border: 1px solid #ffcdd2; }
        .status-success { background: var(--success-green); color: #2e7d32; border: 1px solid #c8e6c9; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; }
        .close-modal { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }

        /* --- SCHEDA RICETTA & EDITING --- */
        #recipeCard { display: none; margin-top: 40px; border: 1px solid #e0e0e0; padding: 30px; border-radius: 12px; background: #fff; position: relative; }
        #recipeCard::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--robo-green); border-radius: 12px 12px 0 0; }
        
        .recipe-header { border-bottom: 2px dashed #eee; margin-bottom: 25px; padding-bottom: 15px; position: relative; }
        .recipe-title { font-family: 'Playfair Display', serif; font-size: 2em; color: var(--robo-green); margin: 0 0 10px 0; font-weight: 700; outline: none; }
        .recipe-meta { font-size: 1em; color: #555; font-weight: bold; background: #f0f0f0; padding: 6px 15px; border-radius: 20px; display: inline-block; outline: none; }

        /* Comportamento campi editabili */
        [contenteditable="true"]:hover { background-color: #fafafa; cursor: text; box-shadow: 0 0 0 1px #ddd inset; border-radius: 4px; }
        [contenteditable="true"]:focus { background-color: #fff; box-shadow: 0 0 0 2px var(--robo-green) inset; border-radius: 4px; padding: 2px 5px; }

        .step { margin-bottom: 25px; background: #fff; position: relative; transition: all 0.2s; }
        .step:hover { background: #fcfcfc; }
        
        .step-web-container { border-left: 4px solid var(--robo-green); padding-left: 15px; }
        .step-action-title { font-weight: bold; color: var(--robo-green); text-transform: uppercase; font-size: 0.85em; letter-spacing: 1px; display: block; margin-bottom: 6px; outline:none; }
        .step-desc { font-size: 1.1em; color: #222; outline:none; white-space: pre-wrap; }
        .robo-tag { display: inline-block; background: #eef5f3; padding: 6px 12px; border-radius: 6px; font-size: 0.95em; font-weight: bold; margin-top: 10px; color: #2c423b; border: 1px solid #dce4e2; font-family: 'Roboto Mono', monospace; outline:none; }

        /* Controlli Editing (Cestino, Aggiungi) */
        .step-controls { position: absolute; right: 0; top: 0; opacity: 0; transition: opacity 0.2s; display: flex; flex-direction: column; gap: 5px; padding: 5px; }
        .step:hover .step-controls { opacity: 1; }
        .btn-del-step { background: #ffecec; color: #d32f2f; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .btn-del-step:hover { background: #ffcdd2; transform: scale(1.1); }

        .btn-add-step { width: 100%; padding: 10px; border: 2px dashed #ddd; background: transparent; color: #888; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn-add-step:hover { border-color: var(--robo-green); color: var(--robo-green); background: #f4f7f6; }

        /* RICETTARIO SALVATO */
        #savedRecipesContainer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; }
        .saved-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .saved-item h3 { margin: 0; font-size: 1.1em; color: var(--robo-dark); }
        .saved-actions { display: flex; gap: 10px; }
        .btn-view { background: var(--robo-green); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-delete { background: #ffecec; color: #d32f2f; border: 1px solid #ffcdd2; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-move { background: #f0f0f0; color: #555; border: 1px solid #ddd; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .btn-move:hover { background: var(--robo-green); color: white; border-color: var(--robo-green); }

        /* ======================================================== */
        /* === CSS STAMPA (PULITO E SENZA STRUMENTI EDIT) === */
        /* ======================================================== */
        @media print {
            .no-print, .input-panel, .tab-group, .section, #savedRecipesContainer, .action-group, .modal, 
            .btn-add-step, .step-controls { display: none !important; }

            body, html { background: white !important; margin: 0 !important; padding: 0 !important; width: 100% !important; overflow: visible !important; }
            .container { box-shadow: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; border: none !important; }
            #recipeCard { display: block !important; margin: 0 !important; padding: 0 !important; border: none !important; width: 100% !important; }
            #recipeCard::before { display: none; }

            /* Rimuovi stili di editing in stampa */
            [contenteditable="true"] { box-shadow: none !important; background: none !important; padding: 0 !important; }

            .recipe-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .recipe-title { font-size: 24pt; color: #000 !important; margin-bottom: 10px; }
            .recipe-meta { border: 1px solid #000; color: #000; background: none !important; padding: 2px 10px; }

            #stepsContainer { counter-reset: step-counter; }
            .step { display: flex !important; align-items: flex-start; page-break-inside: avoid; border-bottom: 1px solid #ccc; padding-bottom: 15px; margin-bottom: 15px; }
            
            .step::before {
                counter-increment: step-counter; content: counter(step-counter);
                background-color: #3f5e55 !important; color: white !important;
                font-weight: bold; font-size: 12pt; width: 30px; height: 30px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }

            .step-web-container { border-left: none !important; padding-left: 0 !important; flex: 1; }
            .step-action-title { color: #000 !important; }
            .step-desc { color: #000 !important; }
            .robo-tag { border: 1px solid #000; background: #fff !important; color: #000 !important; }
            
            #printFooter { display: block !important; text-align: center; margin-top: 50px; font-size: 10px; color: #666; }
        }
        #printFooter { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="no-print">üç≥ RoboCook <span style="font-size:0.4em; vertical-align:middle; background:#2c423b; padding:3px 8px; border-radius:10px; color:white;">ChefGPT Editor</span></h1>

        <div class="section no-print">
            <label>1. Google API Key <button class="btn-help" onclick="toggleModal(true)">‚ùì</button></label>
            <input type="password" id="apiKey" placeholder="Incolla qui la chiave..." />
            <button class="btn-check" onclick="findWorkingModel()">üîÑ Connetti</button>
            <button class="btn-remove" onclick="removeKey()" id="removeBtn" style="display:none;">üóëÔ∏è</button>
            <div id="configStatus" class="status-box"></div>
            <div id="modelSelectionArea" style="display:none; margin-top:10px;">
                <select id="modelSelect" style="width:100%; padding:8px;"></select>
            </div>
        </div>

        <div class="section no-print">
            <label>2. Inserisci Ricetta</label>
            <div class="tab-group">
                <button class="tab-btn" onclick="switchTab('url')">üåê Link</button>
                <button class="tab-btn active" onclick="switchTab('text')">üìù Testo</button>
            </div>
            <div id="panel-url" class="input-panel">
                <input type="text" id="urlInput" placeholder="https://..." />
            </div>
            <div id="panel-text" class="input-panel active">
                <textarea id="recipeInput" style="height:100px" placeholder="Incolla qui il testo..."></textarea>
            </div>
            <button id="convertBtn" class="main-btn btn-primary" onclick="processRecipe()" disabled>üîí Configura API</button>
        </div>

        <div id="recipeCard">
            <div class="no-print" style="background:#e3f2fd; color:#0d47a1; padding:10px; margin-bottom:20px; border-radius:8px; font-size:0.9em; text-align:center;">
                ‚úèÔ∏è <b>Modalit√† Modifica Attiva:</b> Clicca su qualsiasi testo per modificarlo. Salva per confermare.
            </div>

            <div class="recipe-header">
                <h2 id="resTitle" class="recipe-title" contenteditable="true" oninput="updateMeta('title', this.innerText)">...</h2>
                <span id="resServings" class="recipe-meta" contenteditable="true" oninput="updateMeta('servings', this.innerText)">...</span>
            </div>
            
            <div id="stepsContainer"></div>
            
            <button class="btn-add-step no-print" onclick="addNewStep()">‚ûï Aggiungi un nuovo passaggio</button>
            
            <div id="printFooter">Generato con RoboCook</div>
        </div>

        <div class="action-group no-print" id="actionButtons" style="display:none;">
            <button class="main-btn btn-print" onclick="window.print()">üñ®Ô∏è Stampa Ricetta</button>
            <button class="main-btn btn-save" onclick="saveCurrentRecipe()">üíæ Salva Modifiche</button>
        </div>

        <div id="savedRecipesContainer" class="no-print" style="display:none;">
            <h2 style="margin:0 0 15px 0; font-size:1.5em; color:var(--robo-green);">üìö Il Mio Ricettario</h2>
        </br>
            <div class="no-print">
                <button class="btn-help" onclick="exportRecipes()" style="font-size:14px; padding:5px 10px;">‚¨áÔ∏è Export</button>
                <button class="btn-help" onclick="document.getElementById('importFile').click()" style="font-size:14px; padding:5px 10px;">‚¨ÜÔ∏è Import</button>
                <input type="file" id="importFile" style="display:none" onchange="importRecipes(this)" accept=".json">
            </div>
        </br>
            <div id="savedList"></div>
        </div>

    </div>

    <div id="helpModal" class="modal" onclick="closeModalOnClick(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal(false)">&times;</span>
            <h2 style="color:var(--robo-green)">API Key</h2>
            <p>Ottieni la tua chiave su <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>
        </div>
    </div>

    <script>
        let currentMode = 'text';
        let lastGeneratedData = null; // Contiene sempre i dati aggiornati
        const RECIPE_STORAGE_KEY = 'robocook_recipes_v1';
        const API_STORAGE_KEY = 'robocook_key';

        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.input-panel').forEach(p => p.classList.remove('active'));
            if(mode === 'text') {
                document.querySelectorAll('button[onclick="switchTab(\'text\')"]')[0].classList.add('active');
                document.getElementById('panel-text').classList.add('active');
            } else {
                document.querySelectorAll('button[onclick="switchTab(\'url\')"]')[0].classList.add('active');
                document.getElementById('panel-url').classList.add('active');
            }
        }
        function toggleModal(show) { document.getElementById('helpModal').style.display = show ? 'block' : 'none'; }
        function closeModalOnClick(e) { if(e.target==document.getElementById('helpModal')) toggleModal(false); }

        window.onload = function() {
            const k = localStorage.getItem(API_STORAGE_KEY);
            if(k) {
                document.getElementById('apiKey').value = k;
                document.getElementById('removeBtn').style.display = 'inline-flex';
                findWorkingModel(true);
            }
            loadSavedRecipes(); 
        };

        function removeKey() {
            if(confirm("Rimuovere la chiave API?")) { localStorage.removeItem(API_STORAGE_KEY); location.reload(); }
        }

        async function findWorkingModel(auto=false) {
            const key = document.getElementById('apiKey').value.trim();
            const sb = document.getElementById('configStatus');
            const mb = document.getElementById('modelSelect');
            const btn = document.getElementById('convertBtn');

            if(key.length<5) return !auto && alert("Manca la chiave.");
            sb.style.display='block'; sb.className='status-box'; sb.innerText= auto ? "Connessione..." : "Verifica...";

            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
                
                const mods = d.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
                if(mods.length===0) throw new Error("Nessun modello testo.");
                mods.sort((a,b) => (b.name.includes('flash')?1:0)-(a.name.includes('flash')?1:0));

                mb.innerHTML="";
                mods.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name.replace('models/',''); opt.text = opt.value;
                    mb.appendChild(opt);
                });

                localStorage.setItem(API_STORAGE_KEY, key);
                document.getElementById('removeBtn').style.display='inline-flex';
                sb.className='status-box status-success'; sb.innerText="‚úÖ Connesso!";
                document.getElementById('modelSelectionArea').style.display='block';
                btn.disabled=false; btn.innerHTML="‚ú® <b>Genera Ricetta Robot</b>"; btn.style.background="#2e7d32";

            } catch(e) {
                sb.className='status-box status-error'; sb.innerText="‚ùå Errore: " + e.message;
            }
        }

        async function fetchWebPage(url) {
            try {
                const proxyUrl = `https://corsproxy.io/?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("Sito bloccato.");
                const htmlText = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                
                doc.querySelectorAll('script, style, nav, footer, header, iframe').forEach(e => e.remove());
                return (doc.querySelector('main') || doc.body).innerText.substring(0, 30000);
            } catch (e) {
                throw new Error("Sito Protetto. USA IL TAB 'Testo'.");
            }
        }

        async function processRecipe() {
            const key = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelSelect').value;
            const out = document.getElementById('stepsContainer');
            const card = document.getElementById('recipeCard');
            const actBtns = document.getElementById('actionButtons');

            out.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">‚è≥ <b>Analisi in corso...</b></div>';
            card.style.display='block'; actBtns.style.display='none';
            card.scrollIntoView({behavior:'smooth'});

            try {
                let textData = "";
                if(currentMode === 'url') {
                    const url = document.getElementById('urlInput').value;
                    if(!url) throw new Error("Manca URL");
                    out.innerHTML = '<div style="text-align:center; padding:30px;">üåê Scarico dati...</div>';
                    textData = await fetchWebPage(url);
                } else {
                    textData = document.getElementById('recipeInput').value;
                    if(!textData) throw new Error("Manca il testo");
                }

                out.innerHTML = '<div style="text-align:center; padding:30px;">ü§ñ <b>Conversione Robot...</b></div>';

                const PROMPT = `
                Sei un esperto Chef per Robot da cucina multifunzione.
                REGOLE:
                1. Estrai Titolo e Porzioni.
                2. SCRIVI QUANTIT√Ä nel testo (es. "Aggiungere 100g zucchero").
                3. MAPPING:
                   - Trito: 5-10s / Vel 5-8.
                   - Soffritto: 3min / 120¬∞C / Vel 1.
                   - Cottura Sugo/Risotto: 100¬∞C / Antiorario / Vel Soft.
                   - Cibi Delicati (non tritare): Indica ESPLICITAMENTE "Coprilame" se necessario. Ricorda che il coprilame √® un accessorio che non √® necessario utilizzare se nelle fasi successive il prodotto deve essere tritato o frullato. Quando √® utilizzato va inserito PRIMA degli alimenti.
                   - Cottura a Vapore: Se possibile, usa il "Varoma" o setta Temp. Vapore.
                4. Se ci sono alimenti da tritare e mettere da parte questo va fatto nelle prime parti, non se ci sono gi√† parti in cottura.   
                
                OUTPUT JSON:
                { "title": "...", "servings": "...", "steps": [ {"action":"...", "desc":"...", "settings":"..."} ] }
                `;

                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT + "\n\nDATI:\n" + textData }] }] })
                });

                const d = await r.json();
                if(d.error) throw new Error(d.error.message);

                let raw = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();
                const json = JSON.parse(raw);
                
                // Assegniamo un ID nullo perch√© √® una nuova ricetta
                lastGeneratedData = json;
                lastGeneratedData.tempId = Date.now(); // ID temporaneo per gestione sessione

                renderRecipeToCard(lastGeneratedData);

            } catch(e) {
                out.innerHTML = `<div class="status-box status-error">Errore: ${e.message}</div>`;
            }
        }

        // =========================================================
        // === LOGICA EDITING: RENDERIZZAZIONE INTERATTIVA ===
        // =========================================================

        function renderRecipeToCard(data) {
            const titleEl = document.getElementById('resTitle');
            const servEl = document.getElementById('resServings');
            const out = document.getElementById('stepsContainer');
            const card = document.getElementById('recipeCard');
            const actBtns = document.getElementById('actionButtons');

            titleEl.innerText = data.title || "Ricetta";
            servEl.innerText = data.servings || "Dosi non specificate";
            
            out.innerHTML = "";
            data.steps.forEach((s,i) => {
                out.innerHTML += `
                <div class="step">
                    <div class="step-controls">
                    ${i > 0 ? `<button class="btn-move" title="Sposta Su" onclick="moveStep(${i}, -1)">‚ñ≤</button>` : ''}
                        ${i < data.steps.length - 1 ? `<button class="btn-move" title="Sposta Gi√π" onclick="moveStep(${i}, 1)">‚ñº</button>` : ''}
                        <button class="btn-del-step" title="Elimina Passo" onclick="removeStep(${i})">üóëÔ∏è</button>
                    </div>
                    <div class="step-web-container">
                        <span class="step-action-title" contenteditable="true" oninput="updateStep(${i}, 'action', this.innerText)">${s.action}</span>
                        <div class="step-desc" contenteditable="true" oninput="updateStep(${i}, 'desc', this.innerText)">${s.desc}</div>
                        <div class="robo-tag" contenteditable="true" oninput="updateStep(${i}, 'settings', this.innerText)">${s.settings}</div>
                    </div>
                </div>`;
            });

            card.style.display = 'block';
            actBtns.style.display = 'flex';
        }

        // Funzioni di Aggiornamento Dati in Tempo Reale
        function updateMeta(field, value) {
            if(!lastGeneratedData) return;
            lastGeneratedData[field] = value;
        }

        function updateStep(index, field, value) {
            if(!lastGeneratedData || !lastGeneratedData.steps[index]) return;
            lastGeneratedData.steps[index][field] = value;
        }

        function removeStep(index) {
            if(!confirm("Eliminare questo passaggio?")) return;
            lastGeneratedData.steps.splice(index, 1);
            renderRecipeToCard(lastGeneratedData); // Ridisegna per aggiornare gli indici
        }

        function moveStep(index, direction) {
            if (!lastGeneratedData) return;
            const newIndex = index + direction;
            
            // Scambio degli elementi nell'array
            const temp = lastGeneratedData.steps[index];
            lastGeneratedData.steps[index] = lastGeneratedData.steps[newIndex];
            lastGeneratedData.steps[newIndex] = temp;

            renderRecipeToCard(lastGeneratedData);
        }

        function addNewStep() {
            if(!lastGeneratedData) return;
            lastGeneratedData.steps.push({
                action: "NUOVA AZIONE",
                desc: "Descrivi qui cosa fare...",
                settings: "Tempo / Temp / Vel"
            });
            renderRecipeToCard(lastGeneratedData);
            // Scrolla in fondo per vedere il nuovo passo
            document.querySelector('.btn-add-step').scrollIntoView({behavior:'smooth'});
        }

        // =========================================================
        // === SALVATAGGIO & RICETTARIO ===
        // =========================================================

        function getSavedRecipes() {
            const stored = localStorage.getItem(RECIPE_STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveCurrentRecipe() {
            if (!lastGeneratedData) return alert("Nessuna ricetta da salvare.");
            
            let recipes = getSavedRecipes();
            
            // Logica: Se la ricetta era gi√† salvata (ha un savedId), aggiorniamo quella.
            // Altrimenti ne creiamo una nuova.
            const existingIndex = lastGeneratedData.savedId ? recipes.findIndex(r => r.id === lastGeneratedData.savedId) : -1;

            if (existingIndex > -1) {
                // AGGIORNA ESISTENTE
                if(confirm("Questa ricetta √® gi√† nel ricettario. Vuoi sovrascriverla?")) {
                    recipes[existingIndex].data = JSON.parse(JSON.stringify(lastGeneratedData)); // Deep copy pulita
                    recipes[existingIndex].date = new Date().toLocaleDateString() + " (Mod.)";
                    alert("Ricetta aggiornata! üíæ");
                } else {
                    // Salva come copia
                    const newId = Date.now();
                    const newEntry = { id: newId, data: JSON.parse(JSON.stringify(lastGeneratedData)), date: new Date().toLocaleDateString() };
                    newEntry.data.savedId = newId; // Aggiorna ID interno
                    lastGeneratedData.savedId = newId; // Aggiorna sessione corrente
                    recipes.unshift(newEntry);
                    alert("Salvata come nuova copia! üíæ");
                }
            } else {
                // NUOVO SALVATAGGIO
                const newId = Date.now();
                lastGeneratedData.savedId = newId; // Linkiamo i dati a questo ID
                const newEntry = { id: newId, data: JSON.parse(JSON.stringify(lastGeneratedData)), date: new Date().toLocaleDateString() };
                recipes.unshift(newEntry);
                alert("Ricetta salvata nel ricettario! üíæ");
            }
            
            localStorage.setItem(RECIPE_STORAGE_KEY, JSON.stringify(recipes));
            loadSavedRecipes();
        }

        function deleteRecipe(id) {
            if(!confirm("Eliminare questa ricetta?")) return;
            let recipes = getSavedRecipes();
            recipes = recipes.filter(r => r.id !== id);
            localStorage.setItem(RECIPE_STORAGE_KEY, JSON.stringify(recipes));
            
            // Se stiamo visualizzando la ricetta appena cancellata, puliamo la card o rimuoviamo il link ID
            if(lastGeneratedData && lastGeneratedData.savedId === id) {
                lastGeneratedData.savedId = null; // Diventa una ricetta non salvata
            }
            loadSavedRecipes();
        }

        function viewSavedRecipe(id) {
            const recipes = getSavedRecipes();
            const recipe = recipes.find(r => r.id === id);
            if(recipe) {
                // Clona i dati per evitare riferimenti circolari strani
                const dataClone = JSON.parse(JSON.stringify(recipe.data));
                dataClone.savedId = id; // Importante per la logica di aggiornamento
                lastGeneratedData = dataClone;
                
                renderRecipeToCard(lastGeneratedData);
                document.getElementById('recipeCard').scrollIntoView({behavior:'smooth'});
            }
        }

        function loadSavedRecipes() {
            const recipes = getSavedRecipes();
            const container = document.getElementById('savedRecipesContainer');
            const list = document.getElementById('savedList');

            if (recipes.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            list.innerHTML = "";
            recipes.forEach(r => {
                const div = document.createElement('div');
                div.className = 'saved-item';
                div.innerHTML = `
                    <div>
                        <h3>${r.data.title}</h3>
                        <small style="color:#666;">${r.data.servings} ‚Ä¢ ${r.date}</small>
                    </div>
                    <div class="saved-actions">
                        <button class="btn-view" onclick="viewSavedRecipe(${r.id})">üëÅÔ∏è Apri</button>
                        <button class="btn-delete" onclick="deleteRecipe(${r.id})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function exportRecipes() {
            const data = localStorage.getItem(RECIPE_STORAGE_KEY);
            if (!data || data === '[]') return alert("Il ricettario √® vuoto.");
            
            const blob = new Blob([data], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'robocook_backup_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
        }

        function importRecipes(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) throw new Error("Formato file non valido");
                    
                    if(confirm(`Trovate ${imported.length} ricette. Vuoi AGGIUNGERLE al ricettario esistente?\n(Premi OK per aggiungere, Annulla per sostituire tutto)`)) {
                        const current = getSavedRecipes();
                        const merged = [...imported, ...current];
                        // Rimuove eventuali duplicati basati sull'ID
                        const unique = merged.filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i);
                        localStorage.setItem(RECIPE_STORAGE_KEY, JSON.stringify(unique));
                    } else {
                        // Sostituzione totale
                        if(confirm("Sei sicuro? Questo canceller√† le ricette attuali!")) {
                            localStorage.setItem(RECIPE_STORAGE_KEY, JSON.stringify(imported));
                        } else { return; }
                    }
                    loadSavedRecipes();
                    alert("Importazione completata! ‚úÖ");
                } catch(err) {
                    alert("‚ùå Errore durante l'importazione: " + err.message);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Resetta input per permettere di ricaricare lo stesso file
        }
    </script>
</body>
</html>
